{% extends "base.html" %}

{% block content %}
<div class="wiki-container" id="wiki-container">
    <!-- Formulario de búsqueda -->
    <form action="/" method="get">
        <div class="search-options">
            <input type="text" name="query" value="{{ query }}" placeholder="Buscar..." />
            <select name="search_type">
                <option value="title" {% if search_type == 'title' %}selected{% endif %}>Título</option>
                <option value="content" {% if search_type == 'content' %}selected{% endif %}>Contenido</option>
                <option value="authors" {% if search_type == 'authors' %}selected{% endif %}>Autores</option>
            </select>
            <button type="submit">Buscar</button>
        </div>
    </form>

    <div class="entries">
        {% if query %}
            <h2>Resultados para: "{{ query }}"</h2>
            {% if entries %}
                <div class="entry-list">
                    <p><strong>{{ entries|length }}</strong> resultado(s) encontrado(s).</p>
                    {% for entry in entries %}
                        <div class="entry" id="entry-{{ loop.index }}" data-content="{{ entry.content }}">
                            <div class="entry-summary">
                                <h3>{{ entry.title }}</h3>
                                <p>{{ entry.content[:325] }}...</p>
                                <!-- Mostrar el contador de archivos -->
                                <p style="color: blue; text-decoration: underline;">Archivos adjuntos: {{ entry.documentos|length + entry.fotos|length }}</p>
                                <small>Fecha: {{ entry.creation_date }} | Autor(es): {{ entry.authors | join(", ") }}</small>
                                <button class="view-more" data-entry-id="entry-{{ loop.index }}" onclick="toggleEntryDetails('entry-{{ loop.index }}')">Ver más</button>
                            </div>
                            <!-- Detalles de la entrada (ocultos inicialmente) -->
                            <div class="entry-details hidden">
                                <p>{{ entry.content }}</p> <!-- Detalles del contenido -->
                                
                                <!-- Imágenes -->
                                <div class="modal-section-images">
                                    <h3>Imágenes</h3>
                                    <div class="images">
                                        {% for image in entry.fotos %}
                                            <a href="javascript:void(0)" onclick="openImageModal('data:image/jpeg;base64,{{ image }}')">
                                                <img src="data:image/jpeg;base64,{{ image }}" alt="Imagen de la entrada" />
                                            </a>
                                        {% else %}
                                            <p>No hay imágenes disponibles.</p>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Archivos -->
                                <div class="modal-section-attachments">
                                    <h3>Archivos</h3>
                                    <div class="files-container">
                                        {% for file in entry.documentos %}
                                            <div class="file-card">
                                                <div class="file-preview">
                                                    <img src="{{ url_for('static', filename='img/logo_pdf.png') }}" alt="PDF" class="file-icon">
                                                </div>
                                                <div class="file-name">
                                                    <button class="view-pdf" data-pdf="{{ file.base64 }}">
                                                        Ver Documento {{ loop.index }}
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No se encontraron resultados para la búsqueda.</p>
            {% endif %}
        {% else %}
            <h2>Todas las Entradas</h2>
            <div class="entry-list">
                {% for entry in entries %}
                    <div class="entry" id="entry-{{ loop.index }}" data-content="{{ entry.content }}">
                        <div class="entry-summary">
                            <h3>{{ entry.title }}</h3>
                            <p>{{ entry.content[:325] }}...</p>
                            <!-- Mostrar el contador de archivos -->
                            <p style="color: blue; text-decoration: underline;">Archivos adjuntos: {{ entry.documentos|length + entry.fotos|length }}</p>
                            <small>Fecha: {{ entry.creation_date }} | Autor(es): {{ entry.authors | join(", ") }}</small>
                            <button class="view-more" data-entry-id="entry-{{ loop.index }}" onclick="toggleEntryDetails('entry-{{ loop.index }}')">Ver más</button>
                        </div>
                        <!-- Detalles de la entrada (ocultos inicialmente) -->
                        <div class="entry-details hidden">
                            <h1>{{ entry.title }}</h1> <!-- Detalles del contenido -->
                            <p>{{ entry.content }}</p> <!-- Detalles del contenido -->
                            
                            <!-- Imágenes -->
                            <div class="modal-section-images">
                                <h3>Imágenes</h3>
                                <div class="images">
                                    {% for image in entry.fotos %}
                                        <a href="javascript:void(0)" onclick="openImageModal('data:image/jpeg;base64,{{ image }}')">
                                            <img src="data:image/jpeg;base64,{{ image }}" alt="Imagen de la entrada" />
                                        </a>
                                    {% else %}
                                        <p>No hay imágenes disponibles.</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Archivos -->
                            <div class="modal-section-attachments">
                                <h3>Archivos</h3>
                                <div class="files-container">
                                    {% for file in entry.documentos %}
                                        <div class="file-card">
                                            <div class="file-preview">
                                                <img src="{{ url_for('static', filename='img/logo_pdf.png') }}" alt="PDF" class="file-icon">
                                            </div>
                                            <div class="file-name">
                                                <button class="view-pdf" data-pdf="{{ file.base64 }}">
                                                    Ver Documento {{ loop.index }}
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <p>
                                <small>Fecha: {{ entry.creation_date }} | Autor(es): {{ entry.authors | join(", ") }}</small>
                            </p>
                            
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal de imagen -->
<div id="image-modal" class="modal hidden">
    <div class="modal-content">
        <img id="modal-image" src="" alt="Imagen" />
        <button id="close-modal" class="close-modal">Cerrar</button>
    </div>
</div>


<!-- Contenedor para mostrar detalles de la entrada -->
<div id="entry-details-container" class="hidden">
    <button class="back-button" onclick="goBack()">&#8592; Volver</button>
    <div id="entry-details-content">
        <!-- El contenido detallado de la entrada será insertado aquí -->
    </div>
</div>

<div id="pdfViewerContainer" class="hidden">
    <iframe id="pdfViewer" width="100%" height="500px"></iframe>
    <button id="closePdfViewer" class="back-button">Cerrar PDF</button>
</div>

{% endblock %}
